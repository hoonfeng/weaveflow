module: portal
endpoint: tenants_register
method: POST
path: /api/portal/tenants/register
permissions: [portal.tenants.register]
docs:
  title: 租户自助注册
  response:
    description: 返回注册成功后的令牌
    schema:
      type: object
      props:
        code: { type: int }
        msg: { type: string }
        data:
          type: object
          props:
            token: { type: string }
request:
  body:
    tenant_name: { type: string, required: true }
    username: { type: string, required: true }
    email: { type: string, required: true }
    password: { type: string, required: true }
    plan_id: { type: int, required: false }
steps:
  - validate: { target: tenant_name, required: true }
  - validate: { target: username, required: true }
  - validate: { target: email, required: true }
  - validate: { target: password, required: true }
  - sql.query:
      ds: main
      sql: "SELECT id FROM users WHERE username=? LIMIT 1"
      params: { username: "{{ username }}" }
      order: [username]
      out: exists_user
  - transform:
      mapping:
        exists_len: "{{ len exists_user }}"
  - branch:
      if: "{{ gt exists_len 0 }}"
      then:
        - response:
            status: 409
            wrap: { code: 409, msg: username exists, data: {} }
            body: { error: username exists }
      else:
        - transaction: { action: begin, ds: main }
        - sql.exec:
            ds: main
            sql: "INSERT INTO tenants(name,status) VALUES(?,?)"
            params: { name: "{{ tenant_name }}", status: active }
            order: [name, status]
        - sql.query:
            ds: main
            sql: "SELECT LAST_INSERT_ID() AS id"
            params: {}
            out: tenant_row
        - transform:
            mapping:
              tenant_id: "{{ toint tenant_row.0.id }}"
              salt: "{{ uuid }}"
              password_hash: "{{ sha256_concat password salt }}"
        - sql.exec:
            ds: main
            sql: "INSERT INTO users(username,email,password_hash,salt) VALUES(?,?,?,?)"
            params: { username: "{{ username }}", email: "{{ email }}", password_hash: "{{ password_hash }}", salt: "{{ salt }}" }
            order: [username, email, password_hash, salt]
        - sql.query:
            ds: main
            sql: "SELECT LAST_INSERT_ID() AS id"
            params: {}
            out: user_row
        - transform:
            mapping:
              user_id: "{{ toint user_row.0.id }}"
        - sql.exec:
            ds: main
            sql: "INSERT INTO tenant_users(tenant_id,user_id,role) VALUES(?,?,?)"
            params: { tenant_id: "{{ tenant_id }}", user_id: "{{ user_id }}", role: owner }
            order: [tenant_id, user_id, role]
        - branch:
            if: "{{ gt (toint plan_id) 0 }}"
            then:
              - sql.exec:
                  ds: main
                  sql: "INSERT INTO subscriptions(tenant_id,plan_id,status) VALUES(?,?,?)"
                  params: { tenant_id: "{{ tenant_id }}", plan_id: "{{ plan_id }}", status: active }
                  order: [tenant_id, plan_id, status]
        - transaction: { action: commit, ds: main }
        - auth.jwt:
            claims: { uid: "{{ user_id }}", username: "{{ username }}", tenant_id: "{{ tenant_id }}", roles: [], perms: [] }
            out: token
        - response:
            status: 200
            wrap: { code: 0, msg: ok, data: { token: "{{ token }}" } }
            body: { token: "{{ token }}" }
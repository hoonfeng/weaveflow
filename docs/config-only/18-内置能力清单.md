# 内置能力清单（一步到位）

- 目标：把框架可用的"内置能力步骤"与参数说明集中列出，读完即可配置使用。
- 参考实现：步骤解析在 `internal/core/engine.go:33`；能力清单来源包括 `BuiltinsList`（`internal/router/router.go:363`）与 `plugins/admin/vector/sql/http/...` 等实现。
- 相关文档：
  - 接口配置：`03-接口配置.md`
  - 步骤DSL参考：`04-步骤DSL-参考.md`
  - 模板函数：`19-模板函数参考.md`
  - 数据源配置：`08-数据源适配.md`
  - 插件集成：`10-插件集成指南.md`
  - 运维管理：`12-Admin与运维.md`

## 基础响应与校验
- `response`
  - 作用：输出响应，支持包装 `{code,msg,data}`
  - 键：`status`(默认200)、`headers`、`body` 或 `wrap:{code,msg,data}`
  - 相关文档：`04-步骤DSL-参考.md`
  - 例：
    ```yaml
    - response: { status: 200, wrap: { code: 0, msg: ok, data: "{{ users }}" } }
    ```
- `validate`
  - 作用：参数/文件校验
  - 键：`target`、`required|min|max|minLen|maxLen|regex|enum|maxSize|types`
  - 相关文档：`04-步骤DSL-参考.md`
  - 例：
    ```yaml
    - validate: { target: file.files, maxSize: 32MB, types: ["image/png","image/jpeg"] }
    ```
- `transform`
  - 作用：变量映射到 `ctx.vars`
  - 键：`mapping:{ key: template }`
  - 相关文档：`04-步骤DSL-参考.md`
  - 例：`- transform: { mapping: { now_ms: "{{ now ms }}" } }`

## 数据访问
- `sql.query`
  - 键：`ds|sql|params|order|out`
  - 相关文档：`08-数据源适配.md`
  - 例：
    ```yaml
    - sql.query: { ds: main, sql: "SELECT * FROM users WHERE id = ?", params: { id: "{{ path.id }}" }, order: [id], out: users }
    ```
- `sql.exec`
  - 键：`ds|sql|params|order`
  - 相关文档：`08-数据源适配.md`
- `kv.set` / `kv.get`
  - 键：`ds|key|value|out`
  - 相关文档：`08-数据源适配.md`
- `cache.set` / `cache.get`
  - 键：`key|value|ttl|out`
  - 相关文档：`08-数据源适配.md`
- `model.apply`
  - 作用：应用 `configs/models` 中的表模型到 SQL 数据源
  - 键：`ds|dir|out`
  - 相关文档：`08-数据源适配.md`

## 上传与存储
- `upload.save`
  - 作用：保存上传文件到 Blob 存储
  - 键：`ds|input|naming(sha256|uuid|original)|out`
  - 相关文档：`07-文件上传与存储.md`、`08-数据源适配.md`
  - 例：`- upload.save: { ds: local, input: "{{ file.files }}", naming: sha256, out: saved }`

## 外部 HTTP
- `http.request`
  - 键：`method|url|headers|body|timeoutMs|retry|backoff|circuit{key,threshold,openMs,fallback}|out`
  - 相关文档：`04-步骤DSL-参考.md`
  - 例：
    ```yaml
    - http.request:
        method: GET
        url: https://api.example.com/ping
        retry: 2
        backoff: 500
        timeoutMs: 3000
        circuit: { key: ext.ping, threshold: 3, openMs: 30000, fallback: { status: 200, body: ok } }
        out: ping
    ```

## 向量库
- `vector.search`
  - 键：`ds|collection|vec|topK|options|out`
  - 相关文档：`08-数据源适配.md`
- `vector.upsert`
  - 键：`ds|collection|id|vec|meta`
  - 相关文档：`08-数据源适配.md`
- `vector.delete`
  - 键：`ds|collection|id`
  - 相关文档：`08-数据源适配.md`
- `vector.ensure`
  - 键：`ds|collection|size|metric`
  - 相关文档：`08-数据源适配.md`
- `vector.upsert_batch`
  - 键：`ds|collection|items([ {id,vec,meta} ])`
  - 相关文档：`08-数据源适配.md`

## 插件调用与运维
- `plugin.call`
  - 键：`plugin|function|params|retry|backoff|circuit{key,threshold,openMs,fallback}|out`
  - 相关文档：`10-插件集成指南.md`、`17-插件能力与编写指南.md`
- `plugins.status`
  - 键：`out`
  - 相关文档：`10-插件集成指南.md`、`12-Admin与运维.md`
- `plugins.control`
  - 键：`action(enable|disable)|names|enabled`
  - 相关文档：`10-插件集成指南.md`、`12-Admin与运维.md`
- `plugins.add`
  - 键：`name|executable{windows,unix}|instances|timeout|queueSize|functions`
  - 相关文档：`10-插件集成指南.md`、`17-插件能力与编写指南.md`
- `plugins.remove` / `plugins.restart` / `plugins.stop` / `plugins.start`
  - 键：`names`
  - 相关文档：`10-插件集成指南.md`、`12-Admin与运维.md`
- 例：
  ```yaml
  - plugins.status:  { out: plugins }
  - plugins.control: { action: enable, names: [string_reverse], enabled: true }
  ```

## 管理与文档
- `admin.docs`
  - 作用：获取端点文档清单
  - 键：`out`
  - 相关文档：`11-文档与OpenAPI-生成与发布.md`
- `admin.openapi`
  - 作用：生成 OpenAPI 规范
  - 键：`out`
  - 相关文档：`11-文档与OpenAPI-生成与发布.md`
- `admin.builtin`
  - 作用：列出能力清单（Builtins）
  - 键：`out`
  - 相关文档：当前文档（18-内置能力清单.md）
- `admin.plugins_usage`
  - 作用：分析端点对插件的使用情况
  - 键：`out`
  - 相关文档：`10-插件集成指南.md`、`12-Admin与运维.md`
- `admin.permissions_scan`
  - 作用：扫描接口声明的权限码
  - 键：`out`
  - 相关文档：`05-认证与授权.md`、`12-Admin与运维.md`
- `admin.lint`
  - 作用：接口配置检查
  - 键：`out`
  - 相关文档：`13-测试与校验.md`、`12-Admin与运维.md`
- `admin.reload`
  - 作用：热重载配置并返回路由差异
  - 键：`out`
  - 相关文档：`01-快速开始-编译与启动.md`、`12-Admin与运维.md`

## 观测与钩子
- `obs.metrics`
  - 作用：导出 Prometheus 文本指标
  - 键：`out`
- `hooks.inspect`
  - 作用：查看某路由的钩子链
  - 键：`method|path|out`
  - 例：`- hooks.inspect: { method: GET, path: /api/service/compute, out: inspect }`

## 控制流与事务
- `branch`
  - 键：`if|then|else`
- `loop`
  - 键：`items|var|do`
- `transaction`
  - 键：`action(begin|commit|rollback)|ds`
  - 说明：通常通过接口的 `transaction:{ ds }` 自动注入，不必手写。

## 端点限流（接口级）
- 在接口根配置：
  ```yaml
  rateLimit:
    rps: 20
    burst: 50
    perIp: true
    perTenant: false
    perKey: false
  ```

## 安全与认证
- `auth.jwt`
  - 作用：JWT token 签发器
  - 键：`secret`、`claims`、`expiresIn`、`out`
  - 说明：与接口根配置的 `auth: jwt` 字段配合使用，可实现完整的JWT权限校验流程。签发后的token可用于接口认证。
  - 相关配置：
    - 项目配置：`configs/project.yaml` → `security.jwtSecret`（签发密钥）
    - 接口配置：`auth: jwt`（启用JWT认证）、`roles`/`permissions`（权限控制）
    - 环境变量：`JWT_SECRET`（推荐通过环境变量注入密钥）
  - 例：
    ```yaml
    - auth.jwt:
        secret: "{{ env.JWT_SECRET }}"
        claims: { sub: "{{ body.user_id }}", role: "user" }
        expiresIn: "24h"
        out: token
    ```

## 安全（摘要）
- JWT：接口 `auth: jwt`，可设置 `roles|permissions` 校验；签发可用 `auth.jwt` 步骤（由 `helpers.JWTSign` 实现）。
- ApiKey+HMAC：接口 `auth: apikey`，请求头含 `X-Api-Key|X-Timestamp|X-Nonce|X-Signature`；框架校验并防重放。

## 使用建议
- 为关键外部与插件调用配置 `retry/backoff` 与 `circuit`。
- 利用 `admin.lint` 与 `admin.permissions_scan` 做上线前校验。
- 将敏感参数通过环境变量注入（见 `16-环境变量与扩展.md`）。
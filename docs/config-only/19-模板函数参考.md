# 模板函数参考（可直接套用）

- 模板语法：`{{ fn arg1 arg2 ... }}` 或在字符串中内嵌，如 `"Hello {{ upper(body.name) }}"`
- 变量来源：`path|query|header|body|form|file|vars`；支持嵌套访问 `get(obj, 'a.b')`
- 对应实现：`internal/core/engine.go:774`
- 相关文档：
  - 内置能力清单：`18-内置能力清单.md`
  - 步骤DSL参考：`04-步骤DSL-参考.md`
  - 接口配置：`03-接口配置.md`

## 数值与聚合
- `len|count(x)`：集合/字符串长度
- `sum|avg|min|max(arr)`：聚合
- `add|sub|mul|div|mod(a,b)`：运算
- `round|floor|ceil|abs|pow(a,b)`：数学
- `toint(x)`：转换为整数
- `tofloat(x)`：转换为浮点数
- `tostring(x)`：转换为字符串
- `tobool(x)`：转换为布尔值
- 例：`{{ avg(map(users, 'score')) }}`

## 比较与逻辑
- `eq|ne(a,b)`、`gt|ge|lt|le(a,b)`：比较
- `and|or(a,b)`、`not(a)`：逻辑
- `if(cond, then, else)`、`coalesce(a,b,...)`
- `tobool(x)`：转换为布尔值（支持字符串、数字、集合等）
- `contains(arr, value)`：检查数组或字符串是否包含某个值
- 例：`{{ if(gt(len(users),0), 'yes', 'no') }}`

## 字符串与集合
- `upper|lower(s)`、`concat(a,b,...)`、`format(fs, args...)`
- `join(arr, sep)`、`split(s, sep)`
- `replace(s, old, new)`
- `startswith(s, prefix)`：检查字符串是否以指定前缀开头
- `endswith(s, suffix)`：检查字符串是否以指定后缀结尾
- `slice(arr, start, end)`、`range(start, end, step)`
- 去重与集合：`unique(arr)`、`union(a,b)`、`intersect(a,b)`、`diff(a,b)`
- 例：`{{ join(map(users, 'name'), ',') }}`

## 结构访问与变换
- `get(obj, 'a.b')`：取值
- `keys|values(obj)`：键与值
- `indexby(list, 'k')`：按键建索引
- `map(list, 'k')`：映射为值列表
- `filter(list, 'k', val?)`：过滤（值等于或truthy）
- `sort|sortn(list, 'k', 'desc?')`：按键排序（字符串/数值）
- `groupby(list, 'k')`、`sumby|avgby|minby|maxby(list, 'k')`
- `uniqby(list, 'k')`：按键去重
- `pick(obj, keys...)`、`omit(obj, keys...)`、`merge(a,b)`
- `flatten(arr)`、`compact(arr)`

## 编解码与安全
- `json_encode|json_decode(s)`
- `base64_encode|base64_decode(s)`
- `url_encode|url_decode(s)`
- `sha256(s)`、`sha256_concat(a,b)`、`hmac_sha256(msg, key)`
- `uuid()`：随机标识

## 时间
- `now(mode)`：`unix|ms|RFC3339`（默认 RFC3339）
- `format_time(ts, layout?)`、`parse_time(str, layout?)`
- `add_duration(base, dur, layout?)`：在时间上加 `dur`（如 `5m`）
- 例：`{{ add_duration(now unix, '5m') }}`

## 示例组合
```yaml
- transform:
    mapping:
      page:  "{{ coalesce(toint(query.page), 1) }}"
      size:  "{{ coalesce(toint(query.size), 20) }}"
      off:   "{{ mul(vars.page, vars.size) }}"
- sql.query:
    ds: main
    sql: "SELECT id,name,score FROM users LIMIT ? OFFSET ?"
    params: { size: "{{ vars.size }}", off: "{{ vars.off }}" }
    order: [size, off]
    out: users
- response:
    status: 200
    wrap: { code: 0, msg: ok, data: "{{ sortn(users, 'score', 'desc') }}" }
```
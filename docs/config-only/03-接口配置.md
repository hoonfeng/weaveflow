# 接口配置（零代码）

- 位置：`configs/interfaces/<module>/<endpoint>.yaml`
- 通过配置定义路由、认证、限流、事务、文档与步骤，无需编写后端代码。
- 相关文档：
  - 内置能力清单：`18-内置能力清单.md`
  - 模板函数参考：`19-模板函数参考.md`
  - 项目配置：`02-项目配置.md`
  - 认证授权：`05-认证与授权.md`
  - 数据源适配：`08-数据源适配.md`

## 基本结构
```yaml
module: admin                 # 模块名
endpoint: users_list          # 接口标识
method: GET                   # HTTP 方法
path: /api/admin/users        # 路径
auth: jwt                     # 认证策略（jwt|apikey|none）
roles: [admin]                # JWT 角色（Claims: roles）
permissions: [user.read]      # 细粒度权限（Claims: perms）
labels: [ops]
rateLimit: { rps: 50, burst: 100, perIp: true }
docs:
  title: 用户列表
  description: 管理端查询用户列表
request:
  query:
    page: { type: int, required: false, default: 1 }
    size: { type: int, required: false, default: 20 }
steps:
  - sql.query:
      ds: main
      sql: "SELECT id, name, email FROM users LIMIT ? OFFSET ?"
      params: { size: "{{ toint(query.size) }}", off: "{{ mul(toint(query.page), toint(query.size)) }}" }
      order: [size, off]
      out: users
  - response:
      status: 200
      wrap: { code: 0, msg: ok, data: "{{ users }}" }
```

## 配置字段详细说明

### 根级配置字段

| 字段 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| `module` | string | 是 | - | 模块名称，用于接口分组和权限控制 |
| `endpoint` | string | 是 | - | 接口唯一标识，建议使用 `模块_功能` 格式 |
| `method` | string | 是 | - | HTTP方法：GET, POST, PUT, DELETE, PATCH, OPTIONS |
| `path` | string | 是 | - | 接口路径，支持路径参数如 `/api/users/{id}` |
| `auth` | string | 否 | none | 认证策略：`jwt`, `apikey`, `none` |
| `roles` | array[string] | 否 | [] | JWT角色要求，用户需具备至少一个指定角色 |
| `permissions` | array[string] | 否 | [] | 细粒度权限要求，用户需具备所有指定权限 |
| `labels` | array[string] | 否 | [] | 标签，用于接口分类和监控 |
| `rateLimit` | object | 否 | - | 限流配置，详见限流章节 |
| `transaction` | object | 否 | - | 事务配置，详见事务章节 |
| `docs` | object | 否 | - | 接口文档配置，详见文档章节 |
| `request` | object | 否 | - | 请求参数配置，详见请求章节 |
| `steps` | array[object] | 是 | - | 执行步骤链，详见步骤DSL参考 |
| `hooks` | object | 否 | - | 钩子配置，详见钩子章节 |

### 请求参数配置 (request)

#### query - URL查询参数
```yaml
request:
  query:
    page: 
      type: int           # 参数类型：int, string, bool, float
      required: false     # 是否必填
      default: 1         # 默认值
      min: 1              # 最小值（数字类型）
      max: 100            # 最大值（数字类型）
      minLen: 1           # 最小长度（字符串类型）
      maxLen: 100        # 最大长度（字符串类型）
      desc: "分页页码"    # 参数描述
```

#### body - 请求体参数
```yaml
request:
  body:
    username:
      type: string
      required: true
      minLen: 3
      maxLen: 20
      desc: "用户名"
    email:
      type: string
      required: false
      format: email       # 格式校验：email, url, uuid, date, date-time
      desc: "邮箱地址"
```

#### header - 请求头参数
```yaml
request:
  header:
    X-Request-ID:
      type: string
      required: false
      desc: "请求ID"
    Authorization:
      type: string
      required: true
      desc: "认证令牌"
```

#### path - 路径参数
```yaml
request:
  path:
    id:
      type: int
      required: true
      desc: "用户ID"
```

#### file - 文件上传参数
```yaml
request:
  file:
    avatar:
      required: true
      maxSize: 5MB        # 最大文件大小：B, KB, MB, GB
      types: ["image/jpeg", "image/png"]  # 允许的MIME类型
      desc: "用户头像"
```

### 限流配置 (rateLimit)

```yaml
rateLimit:
  rps: 50                 # 每秒请求数限制
  burst: 100              # 突发请求数限制
  perIp: true            # 是否按IP限流
  perTenant: false       # 是否按租户限流
  perKey: false          # 是否按API Key限流
  key: "{{ header.X-API-Key }}"  # 自定义限流键
```

### 事务配置 (transaction)

```yaml
transaction:
  ds: main               # 数据源名称
  isolation: read_committed  # 事务隔离级别：read_uncommitted, read_committed, repeatable_read, serializable
  timeout: 30s           # 事务超时时间
```

### 文档配置 (docs)

```yaml
docs:
  title: "用户列表"       # 接口标题
  description: "管理端查询用户列表接口"  # 接口详细描述
  deprecated: false      # 是否已弃用
  tags: ["用户管理"]     # OpenAPI标签
  
  # 响应文档
  response:
    description: "返回用户列表数据"
    headers:
      X-Total-Count: { type: int, desc: "总记录数" }
    schema:
      type: object
      props:
        code: { type: int, desc: "状态码" }
        msg: { type: string, desc: "消息" }
        data: 
          type: object
          props:
            items: 
              type: array
              props:
                item: 
                  type: object
                  props:
                    id: { type: int, desc: "用户ID" }
                    name: { type: string, desc: "用户名" }
    
  # 错误文档          
  errors:
    - code: "E_AUTH_FAILED"
      message: "认证失败"
      description: "Token无效或已过期"
      status: 401
```

### 钩子配置 (hooks)

```yaml
hooks:
  # 禁用全局钩子
  disable: ["global_auth", "global_log"]
  
  # 前置钩子
  before:
    - kind: transform     # 钩子类型：transform, plugin, http
      name: "preprocess"  # 钩子名称
      match:             # 匹配条件
        module: "admin"
        pathPrefix: "/api/admin"
      params:            # 钩子参数
        format: "json"
  
  # 后置钩子          
  after:
    - kind: plugin
      name: "audit"
      match: {}
      params:
        plugin: "audit_log"
        function: "record"
```

## 可选：事务
```yaml
transaction: { ds: main }
```
- 路由将自动插入 `begin/commit`；失败时执行 `rollback`。

## 认证示例
- JWT：`Authorization: Bearer <token>`
- ApiKey+HMAC（需将 `auth` 设为 `apikey`）：
  - 请求头：`X-Api-Key | X-Timestamp | X-Nonce | X-Signature`
  - 签名串：`METHOD\nPATH\nTS\nNONCE\nBODY_HASH`

## 限流（端点级）
```yaml
rateLimit:
  rps: 20
  burst: 50
  perIp: true
  perTenant: false
  perKey: false
```

## 钩子覆盖/禁用
```yaml
hooks:
  disable: [global_auth_check]
  before:
    - { kind: plugin, name: precheck, match: { module: admin }, params: { plugin: metrics, function: preflight } }
  after:
    - { kind: plugin, name: audit, match: { pathPrefix: "/api/admin" }, params: { plugin: metrics, function: audit } }
```

## 文档提示
- `docs.title|description` 与 `response.headers/description/schema` 可完善生成手册与 OpenAPI。
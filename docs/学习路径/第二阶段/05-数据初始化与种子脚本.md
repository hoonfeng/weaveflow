# 数据初始化与种子脚本

目标：通过步骤 DSL 编写“幂等”的数据初始化脚本，服务启动自动执行，确保基础数据（如管理员账号、默认配置）存在且可更新。

## 启用与执行
- 配置位置：`configs/project.yaml` → `init.enabled: true` 与 `init.scripts: [configs/init/minimal.yaml, ...]`
- 执行入口：`cmd/server/main.go`
  - 服务启动后，按顺序读取并执行 `init.scripts` 中声明的脚本；
  - 若脚本不产生 HTTP `response`，会被视为成功（脚本型步骤无需输出）。

## 脚本结构与常用步骤
- 顶层键：`steps`（数组，按序执行）
- 常用步骤：
  - `sql.query`：查询数据（支持 `params` 绑定与 `out` 输出）
  - `transform`：变量映射与模板函数运算（如 `uuid`、`sha256_concat`）
  - `branch`：条件分支（`if`、`then`、`else`）
  - `sql.exec`：写操作（插入/更新/删除，支持 `params` 绑定）

示例（摘自 `configs/init/minimal.yaml`）：

```yaml
steps:
  - sql.query:
      ds: main
      sql: "SELECT id, username, email, salt FROM users WHERE username = ? LIMIT 1"
      params:
        username: admin
      out: u
  - transform:
      mapping:
        ulen: "{{ len u }}"
  - branch:
      if: "{{ gt ulen 0 }}"
      then:
        - transform:
            mapping:
              salt: "{{ uuid 'admin' }}"
              ph: "{{ sha256_concat 'admin123' salt }}"
              uid: "{{ u.0.id }}"
        - sql.exec:
            ds: main
            sql: "UPDATE users SET salt = ?, password_hash = ? WHERE id = ?"
            params:
              salt: "{{ salt }}"
              password_hash: "{{ ph }}"
              id: "{{ uid }}"
      else:
        - transform:
            mapping:
              salt: "{{ uuid 'admin' }}"
              ph: "{{ sha256_concat 'admin123' salt }}"
        - sql.exec:
            ds: main
            sql: "INSERT INTO users(username, email, password_hash, salt) VALUES(?, ?, ?, ?)"
            params:
              username: admin
              email: admin@example.com
              password_hash: "{{ ph }}"
              salt: "{{ salt }}"
```

要点解析：
- 幂等性：先查询是否存在，再决定更新或插入；避免重复插入。
- 参数绑定：`?` 占位与 `params` 映射结合，防止 SQL 注入。
- 模板函数：`uuid` 用于生成稳定随机盐，`sha256_concat` 用于派生口令哈希。

## 新增自定义种子脚本的步骤
1. 在 `configs/init/` 新建 `your_seed.yaml`，编写 `steps`，确保幂等性（先查再改）。
2. 在 `configs/project.yaml` 的 `init.scripts` 列表中追加刚才的脚本路径。
3. 重启服务或触发配置热重载，脚本将按顺序执行。

## 设计建议与注意事项
- 脚本应尽量“纯后端逻辑”，不依赖外部交互；
- 分步骤记录“意图”：查询→变换→分支→执行，便于审计与维护；
- 避免将明文口令或敏感信息写入仓库；可通过 `.env` 注入再在脚本中引用；
- 失败处理：执行中出现错误会在日志中打印，定位路径与错误详情，逐一修复后重试；
- 数据源选择：`ds: main` 对应 `configs/project.yaml` 的主 SQL 数据源；按需扩展并选择其它数据源。

## 深入参考
- 启动时种子执行：`cmd/server/main.go`
- 步骤执行引擎与模板函数：`internal/core/engine.go`（执行）、`internal/core`（函数集合）
- 示例脚本：`configs/init/minimal.yaml`
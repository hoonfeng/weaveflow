# 第二阶段：核心功能掌握（3-5天）

## 2.2 数据操作能力

### 目标
掌握SQL操作步骤，实现数据库的增删改查功能。

### 2.2.1 SQL操作步骤概述

框架提供强大的SQL操作能力，支持多种数据库操作：

**主要步骤类型（当前实现）：**
- `sql.query`: 执行查询操作，返回数据
- `sql.exec`: 执行增删改操作
- 接口级事务：在接口配置中声明 `transaction: { ds: <sql-datasource> }`，路由自动插入 `begin/commit`

### 2.2.2 sql.query - 数据查询

**执行查询操作：**
```yaml
steps:
  - sql.query:
      ds: main                  # 数据源名称
      sql: "SELECT * FROM users WHERE id = ?"  # SQL语句
      params:                   # 参数绑定
        id: "{{ toint(path.id) }}"
      order: [id]               # 参数顺序
      out: user                # 输出变量名
```

**查询结果处理：**
- 单行结果：返回对象 `{field: value}`
- 多行结果：返回数组 `[{field: value}, ...]`
- 无结果：返回 `null`

**查询示例：**
```yaml
# 查询单个用户
steps:
  - sql.query:
      ds: main
      sql: "SELECT id, name, email, created_at FROM users WHERE id = ?"
      params: { id: "{{ toint(path.id) }}" }
      out: user

# 查询用户列表（带分页）
steps:
  - sql.query:
      ds: main
      sql: |
        SELECT id, name, email, status, created_at 
        FROM users 
        WHERE status = 'active'
        ORDER BY created_at DESC
        LIMIT ? OFFSET ?
      params:
        limit: "{{ toint(query.size) }}"
        offset: "{{ mul(sub(toint(query.page), 1), toint(query.size)) }}"
      order: [limit, offset]
      out: users
```

### 2.2.3 sql.exec - 数据操作

**执行增删改操作：**
```yaml
steps:
  - sql.exec:
      ds: main                  # 数据源名称
      sql: "INSERT INTO users (name, email, password) VALUES (?, ?, ?)"
      params:
        name: "{{ body.name }}"
        email: "{{ body.email }}"
        password: "{{ sha256(body.password) }}"
      order: [name, email, password]
      out: result              # 输出结果
```

**操作结果：**
- 返回对象 `{rowsAffected: number, lastInsertId: number}`
- `rowsAffected`: 影响的行数
- `lastInsertId`: 最后插入的ID（如果支持）

**操作示例：**
```yaml
# 创建用户
steps:
  - sql.exec:
      ds: main
      sql: |
        INSERT INTO users (name, email, password, status, created_at)
        VALUES (?, ?, ?, 'active', NOW())
      params:
        name: "{{ body.name }}"
        email: "{{ body.email }}"
        password: "{{ sha256(body.password) }}"
      order: [name, email, password]
      out: create_result

# 更新用户信息
steps:
  - sql.exec:
      ds: main
      sql: "UPDATE users SET name = ?, email = ? WHERE id = ?"
      params:
        name: "{{ body.name }}"
        email: "{{ body.email }}"
        id: "{{ toint(path.id) }}"
      order: [name, email, id]
      out: update_result

# 删除用户
steps:
  - sql.exec:
      ds: main
      sql: "DELETE FROM users WHERE id = ?"
      params: { id: "{{ toint(path.id) }}" }
      out: delete_result
```

### 2.2.4 条件SQL和模板函数

**使用条件SQL：**
```yaml
steps:
  - sql.query:
      ds: main
      sql: |
        SELECT id, name, email, status, created_at
        FROM users
        WHERE 1=1
        {{ if query.status }}AND status = ?{{ end }}
        {{ if query.search }}AND (name LIKE ? OR email LIKE ?){{ end }}
        ORDER BY created_at DESC
        LIMIT ? OFFSET ?
      params:
        status: "{{ query.status }}"
        search: "{{ '%' + query.search + '%' if query.search else '' }}"
        limit: "{{ toint(query.size) }}"
        offset: "{{ mul(sub(toint(query.page), 1), toint(query.size)) }}"
      order: [status, search, search, limit, offset]
      out: users
```

**常用模板函数：**
- `toint(value)`: 转换为整数
- `default(value, default)`: 提供默认值
- `mul(a, b)`: 乘法运算
- `sub(a, b)`: 减法运算
- `sha256(str)`: SHA256哈希
- `now`: 当前时间
- `uuid`: 生成UUID

### 2.2.5 事务管理

**使用事务：**
```yaml
module: orders
endpoint: create_order
method: POST
path: /api/orders

transaction: { ds: main }  # 启用接口级事务（指定SQL数据源）

steps:
  # 1. 创建订单
  - sql.exec:
      ds: main
      sql: |
        INSERT INTO orders (user_id, amount, status, created_at)
        VALUES (?, ?, 'pending', NOW())
      params:
        user_id: "{{ toint(body.user_id) }}"
        amount: "{{ tofloat(body.amount) }}"
      order: [user_id, amount]
      out: order_result

  # 2. 扣减库存（在事务中执行）
  - sql.exec:
      ds: main
      sql: "UPDATE products SET stock = stock - ? WHERE id = ? AND stock >= ?"
      params:
        quantity: "{{ toint(body.quantity) }}"
        product_id: "{{ toint(body.product_id) }}"
        quantity_check: "{{ toint(body.quantity) }}"
      order: [quantity, product_id, quantity_check]
      out: update_result

  # 3. 返回结果（事务自动提交或回滚）
  - response:
      status: 201
      wrap:
        code: 0
        msg: "订单创建成功"
        data:
          order_id: "{{ order_result.lastInsertId }}"
          affected_rows: "{{ update_result.rowsAffected }}"
```

**事务特性：**
- 在接口配置中设置 `transaction: { ds: <name> }` 启用事务
- 所有SQL步骤在同一个事务中执行
- 任何步骤失败都会回滚事务
- 成功完成所有步骤后自动提交

### 2.2.6 完整CRUD示例

**用户管理完整接口：**

```yaml
# 1. 获取用户列表
module: users
endpoint: list_users
method: GET
path: /api/users

steps:
  - sql.query:
      ds: main
      sql: |
        SELECT id, name, email, status, created_at
        FROM users
        {{ if query.search }}WHERE name LIKE ? OR email LIKE ?{{ end }}
        ORDER BY created_at DESC
        LIMIT ? OFFSET ?
      params:
        search: "{{ '%' + query.search + '%' if query.search else '' }}"
        limit: "{{ toint(query.size) }}"
        offset: "{{ mul(sub(toint(query.page), 1), toint(query.size)) }}"
      order: [search, search, limit, offset]
      out: users

  - response:
      status: 200
      wrap:
        code: 0
        msg: "success"
        data: "{{ users }}"

# 2. 获取单个用户
module: users
endpoint: get_user
method: GET
path: /api/users/{id}

steps:
  - sql.query:
      ds: main
      sql: "SELECT id, name, email, status, created_at FROM users WHERE id = ?"
      params: { id: "{{ toint(path.id) }}" }
      out: user

  - response:
      status: 200
      wrap:
        code: 0
        msg: "success"
        data: "{{ user }}"

# 3. 创建用户
module: users
endpoint: create_user
method: POST
path: /api/users

steps:
  - sql.exec:
      ds: main
      sql: |
        INSERT INTO users (name, email, password, status, created_at)
        VALUES (?, ?, ?, 'active', NOW())
      params:
        name: "{{ body.name }}"
        email: "{{ body.email }}"
        password: "{{ sha256(body.password) }}"
      order: [name, email, password]
      out: result

  - response:
      status: 201
      wrap:
        code: 0
        msg: "用户创建成功"
        data:
          user_id: "{{ result.lastInsertId }}"

# 4. 更新用户
module: users
endpoint: update_user
method: PUT
path: /api/users/{id}

steps:
  - sql.exec:
      ds: main
      sql: "UPDATE users SET name = ?, email = ? WHERE id = ?"
      params:
        name: "{{ body.name }}"
        email: "{{ body.email }}"
        id: "{{ toint(path.id) }}"
      order: [name, email, id]
      out: result

  - response:
      status: 200
      wrap:
        code: 0
        msg: "用户更新成功"
        data:
          affected_rows: "{{ result.rowsAffected }}"

# 5. 删除用户
module: users
endpoint: delete_user
method: DELETE
path: /api/users/{id}

steps:
  - sql.exec:
      ds: main
      sql: "DELETE FROM users WHERE id = ?"
      params: { id: "{{ toint(path.id) }}" }
      out: result

  - response:
      status: 200
      wrap:
        code: 0
        msg: "用户删除成功"
        data:
          affected_rows: "{{ result.rowsAffected }}"
```

### 2.2.7 实践任务

**完成以下实践任务：**

1. **创建查询接口**
   - 创建带条件查询的用户列表接口
   - 支持分页、搜索、状态过滤
   - 使用条件SQL和模板函数

2. **创建数据操作接口**
   - 创建用户注册接口（INSERT）
   - 创建用户信息更新接口（UPDATE）
   - 创建用户删除接口（DELETE）

3. **实现事务操作**
   - 创建需要事务支持的复杂业务接口
   - 验证事务的回滚和提交机制

### 2.2.8 常见问题

**Q: SQL执行失败怎么办？**
A: 框架会返回详细的错误信息，包括SQL错误和参数信息。

**Q: 如何调试SQL语句？**
A: 查看服务日志，框架会记录执行的SQL语句和参数。

**Q: 支持哪些数据库？**
A: 支持MySQL、PostgreSQL、SQLite等主流数据库。

**Q: 如何处理SQL注入？**
A: 框架使用参数化查询，自动防止SQL注入攻击。

### 2.2.9 下一步学习

掌握数据操作能力后，继续学习：[认证与权限控制](./03-认证与权限控制.md) 掌握接口安全控制。
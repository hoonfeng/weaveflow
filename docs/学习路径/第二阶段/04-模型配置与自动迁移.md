# 模型配置与自动迁移

目标：使用 YAML 描述数据库模型，并在服务启动或通过管理接口自动迁移到 MySQL，确保表、列、索引按模型定义存在。

## 前置准备
- 在 `configs/project.yaml` 配置 `datasources.sql.main.dsn`（例如：`user:pass@tcp(127.0.0.1:3306)/ifaceconf?parseTime=true`）。
- 确认模型目录：`configs/models/`。

## 模型 YAML 结构
- `table`：表名
- `columns`：列定义（键为列名）
  - 支持属性：`type`、`pk`、`auto`、`notNull`、`default`、`unique`
- `indexes`：索引定义数组
  - 属性：`name`、`columns`、`unique`

示例（摘自 `configs/models/user.yaml`）：

```yaml
table: users
columns:
  id: { type: BIGINT, pk: true, auto: true }
  username: { type: VARCHAR(64), notNull: true, unique: true }
  email: { type: VARCHAR(128), notNull: true }
  password_hash: { type: VARCHAR(128), notNull: true }
  salt: { type: VARCHAR(64), notNull: true }
  created_at: { type: TIMESTAMP, default: CURRENT_TIMESTAMP }
indexes:
  - name: idx_users_email
    columns: [email]
```

## 字段详解
- `table`
  - 含义：目标数据库表名（必填）。
  - 作用：生成 `CREATE TABLE IF NOT EXISTS <table>` 语句（InnoDB/utf8mb4）。
  - 约束：仅支持合法的 MySQL 表名；不建议使用保留字。
  - 扩展：`comment`（可选），表备注，生成 `COMMENT='<text>'`。

- `columns`
  - 含义：表的列集合。键为列名，值为列的属性对象。
  - 作用：用于生成列定义并在迁移时“增量添加缺失列”。
  - 子属性：
    - `type`
      - 含义：MySQL 列类型及长度/精度（必填）。
      - 示例：`VARCHAR(64)`、`BIGINT`、`INT`、`DECIMAL(10,2)`、`TIMESTAMP`、`TEXT`。
      - 注意：类型变更不会自动执行（需手工 `ALTER TABLE`）。
    - `pk`
      - 含义：是否为主键列（布尔）。
      - 作用：多个列设置为 `pk: true` 时会生成复合主键。
      - 注意：主键的变更（新增/删除）仅在建表时生效；已有表的主键结构不会自动变更。
    - `auto`
      - 含义：是否启用 `AUTO_INCREMENT`（布尔）。
      - 前提：仅对整数类型且通常用于单列主键有效；MySQL 限制每表一个自增列。
    - `notNull`
      - 含义：是否为 `NOT NULL`（布尔）。
      - 作用：新增列时会附加 `NOT NULL`；若已有数据且没有默认值，可能失败。
    - `default`
      - 含义：列默认值（字符串，按原样拼接到 SQL）。
      - 示例：`CURRENT_TIMESTAMP`（函数，不加引号）；`'active'`（字符串，需手动加单引号）。
      - 注意：请写成合法的 SQL 片段，系统不会自动加引号。
    - `unique`
      - 含义：是否为唯一列（布尔）。
      - 作用：自动生成单列唯一索引，命名规则：`uniq_<table>_<column>`。
      - 对比：与在 `indexes` 中声明多列唯一索引不同，此处仅针对单列。
    - `comment`
      - 含义：列备注（字符串）。
      - 作用：在建表或新增列时生成 `COMMENT '<text>'`；已存在列不会自动更新备注。

- `indexes`
  - 含义：显式索引定义数组。
  - 子属性：
    - `name`
      - 含义：索引名称（必填，表内唯一）。
      - 注意：名称不可与自动生成的 `uniq_<table>_<column>` 冲突。
    - `columns`
      - 含义：参与索引的列列表（按顺序）。
      - 示例：`[email]`、`[tenant_id, created_at]`。
    - `unique`
      - 含义：是否为唯一索引（布尔）。
      - 作用：生成 `CREATE UNIQUE INDEX`；用于多列唯一约束场景。

## 自动迁移的触发方式
1) 服务启动自动迁移（推荐）
- 入口：`cmd/server/main.go`
- 启动时：加载模型并调用 `ApplyModels`，完成表、列、索引增量对齐。
- 涉及代码（关键逻辑）：
  - 读取 `configs/models` → `internal/model.Load`
  - 应用迁移 → `internal/model.ApplyModels`

2) 管理接口触发迁移
- 接口定义：`configs/interfaces/admin/system/migrate.yaml`
- 端点：`POST /api/admin/migrate`（需 `admin` 角色与 `admin.migrate` 权限）
- 步骤：`model.apply` 将目录中的模型应用到目标数据源，并返回表名列表。

### `model.apply` 步骤参数
- `ds`
  - 含义：数据源名称（例如 `main`）。
  - 来源：`configs/project.yaml` → `datasources.sql` 中的键名。
- `dir`
  - 含义：模型目录路径（相对项目根），通常为 `configs/models`。
- `out`
  - 含义：将迁移结果（表名数组）存入指定变量，以便后续步骤或响应引用。

返回值说明：当迁移成功时，`out` 对应的变量为 `string[]`，包含所有模型表名，如 `['users', 'roles']`。

## 索引与唯一约束说明
- 在 `indexes` 中定义普通或唯一索引；`columns` 列表按顺序组成索引键。
- 若列上设置 `unique: true`，系统会自动生成唯一索引（命名规则：`uniq_<table>_<column>`）。

## 添加/更新模型的建议流程
1. 在 `configs/models` 新增或修改 `*.yaml`（遵循上面的结构）。
2. 重启服务或调用 `POST /api/admin/migrate` 以应用更改。
3. 通过数据库或日志确认结果；失败时检查 `type/default/notNull` 等属性是否符合当前数据库版本与约束。

## 约束与注意事项
- 迁移策略为“增量对齐”：
  - 自动创建缺失的表、缺失的列与缺失的索引；
  - 不会自动删除已有列或索引，也不会自动修改列类型（涉及数据风险），此类变更需手工执行 `ALTER TABLE`。
- `default` 值按原样拼接到 DDL 中：
  - 例如 `CURRENT_TIMESTAMP` 无需引号；字符串默认值需按数据库语法使用引号。
- 多列主键：通过在多个列上设置 `pk: true` 实现；
- 版本兼容：请使用 MySQL 8.0+，并确保连接用户具备 `CREATE/ALTER` 权限。
 - 备注（`comment`）更新：仅在“建表”或“新增列”时生效；对已有对象的备注修改需自行执行 `ALTER TABLE ... COMMENT` 或 `ALTER TABLE ... MODIFY COLUMN ... COMMENT`。

## 迁移行为细则（实现依据）
- 建表：`CREATE TABLE IF NOT EXISTS <table> (...) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4`（源码：`GenerateDDL`）。
- 列对齐：查询 `information_schema.COLUMNS`，对缺失列执行 `ALTER TABLE ADD COLUMN`（源码：`ensureColumns`）。
- 索引对齐：查询 `information_schema.STATISTICS`，对缺失索引执行 `CREATE INDEX/CREATE UNIQUE INDEX`；并为 `unique: true` 的列补充单列唯一索引（源码：`ensureIndexes`）。

## 深入参考
- 加载与迁移实现：`internal/model/model.go`
- 启动时迁移流程：`cmd/server/main.go`
- 管理端迁移接口：`configs/interfaces/admin/system/migrate.yaml`
# 文件上传与存储配置

## 文件上传参数声明

### 基本文件上传配置
```yaml
request:
  file:
    files: { required: true, maxSize: 32MB, types: ["image/png","image/jpeg"] }
```

### 多文件上传配置
```yaml
request:
  file:
    images: { required: true, maxSize: 10MB, types: ["image/*"] }
    documents: { required: false, maxSize: 50MB, types: ["application/pdf","text/plain"] }
```

## 解析兼容性

### 支持的上传格式
- `multipart/form-data`：自动解析表单与文件
- 原始体上传：当无法解析为多部件时，框架将请求体视为单文件 `infile`

## 保存到 Blob 存储

### 本地存储配置
```yaml
# configs/project.yaml 中的配置（datasources.blob）
datasources:
  blob:
    local:
      type: local
      basePath: storage/  # 默认存储路径
```

### 文件保存步骤
```yaml
steps:
  - upload.save: 
      ds: local 
      input: "{{ file.files }}" 
      naming: sha256 
      out: file_ids
```

### 命名策略选项
- `sha256`：使用文件内容的SHA256哈希作为文件名
- `uuid`：生成UUID作为文件名
- `original`：保留原始文件名

## 完整文件上传接口示例

### 图片上传接口
```yaml
module: media
endpoint: upload_image
method: POST
path: /api/media/images
request:
  file:
    image: { required: true, maxSize: 10MB, types: ["image/jpeg","image/png","image/gif"] }
  body:
    title: { type: string, required: false, maxLen: 100 }
    description: { type: string, required: false, maxLen: 500 }

steps:
  - upload.save:
      ds: local
      input: "{{ file.image }}"
      naming: sha256
      out: file_ids
  
  - sql.exec:
      ds: main
      sql: "INSERT INTO images (file_name, title, description) VALUES (?, ?, ?)"
      params:
        file_name: "{{ file_ids.0 }}"   # 取第一个保存ID
        title: "{{ body.title }}"
        description: "{{ body.description }}"
      out: insert_result

  - response:
      status: 201
      body: 
        code: 0
        data: 
          id: "{{ insert_result.lastInsertId }}"
          file_name: "{{ file_ids.0 }}"
          url: "/storage/{{ file_ids.0 }}"
```

### 多文件上传接口
```yaml
module: media
endpoint: upload_multiple
method: POST
path: /api/media/batch
request:
  file:
    attachments: { required: true, maxSize: 50MB, types: ["*/*"], maxCount: 10 }

steps:
  - upload.save:
      ds: local
      input: "{{ file.attachments }}"
      naming: uuid
      out: uploaded_ids
  
  - loop:
      items: "{{ uploaded_ids }}"
      var: fid
      do:
        - sql.exec:
            ds: main
            sql: "INSERT INTO attachments (file_id) VALUES (?)"
            params:
              file_id: "{{ fid }}"

  - response:
      status: 200
      body:
        code: 0
        data: 
          count: "{{ len(uploaded_ids) }}"
          files: "{{ uploaded_ids }}"
```

## 文件访问与展示

上传保存的文件名可直接用于静态托管或业务接口返回的下载URL（例如 `/storage/<id>`）。如需带权限下载，建议通过业务表记录文件ID并在受保护接口中校验后返回内容或签名URL。

## 安全注意事项

1. **文件类型限制**：始终限制允许的文件类型
2. **大小限制**：设置合理的文件大小上限
3. **病毒扫描**：对于用户上传的文件，建议集成病毒扫描
4. **访问控制**：确保文件下载接口有适当的权限控制
5. **存储隔离**：用户上传的文件应存储在非web根目录下

## 下一步学习

完成文件上传配置后，继续学习：[数据源适配与扩展](../第三阶段/03-数据源适配.md)
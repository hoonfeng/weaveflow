# 文档生成与运维管理

## 自动化文档生成

### 接口手册生成

生成详细的接口文档，包含每个接口的完整说明：

```bash
# 生成接口手册
go run ./cmd/manualdoc --out docs/manual
```

**生成内容：**
- `docs/manual/index.md` - 模块索引
- `docs/manual/{module}.md` - 每个模块的详细文档
- 包含请求参数、响应格式、示例等完整信息

### OpenAPI 规范生成

生成符合OpenAPI 3.0规范的API文档：

```bash
# 生成OpenAPI文档
go run ./cmd/docgen --out docs/generated
```

**生成内容：**
- `docs/generated/openapi.json` - 完整的OpenAPI规范
- `docs/generated/openapi.{module}.json` - 按模块分割的OpenAPI文件
- `docs/generated/{module}.md` - 模块文档汇总

## 文档字段增强

### 接口文档配置示例
```yaml
module: users
endpoint: create_user
method: POST
path: /api/users
docs:
  title: "创建用户"
  description: |
    创建一个新用户账户。
    需要管理员权限。
  tags: [用户管理]

request:
  body:
    name: 
      type: string
      required: true
      description: "用户姓名"
      example: "张三"
    email:
      type: string
      required: true
      description: "用户邮箱"
      example: "zhangsan@example.com"

response:
  status: 201
  description: "用户创建成功"
  headers:
    X-Request-Id:
      description: "请求ID"
      example: "req_123456"
  body:
    schema:
      type: object
      properties:
        id:
          type: integer
          description: "用户ID"
          example: 123
        name:
          type: string
          description: "用户姓名"
          example: "张三"
    example:
      id: 123
      name: "张三"
```

### 响应文档配置
```yaml
response:
  status: 200
  description: "获取用户信息成功"
  body:
    schema:
      type: object
      properties:
        id:
          type: integer
          description: "用户ID"
        name:
          type: string
          description: "用户姓名"
        email:
          type: string
          description: "用户邮箱"
    example:
      id: 123
      name: "张三"
      email: "zhangsan@example.com"
```

## Admin 运维管理

### 常用管理操作

```yaml
# 查看所有端点信息
- admin.docs: { out: endpoints_info }

# 生成OpenAPI规范
- admin.openapi: { out: openapi_spec }

# 扫描权限声明
- admin.permissions_scan: { out: permissions }

# 分析插件使用情况
- admin.plugins_usage: { out: plugins_usage }

# 接口配置检查
- admin.lint: { out: lint_results }

# 热重载配置
- admin.reload: { out: reload_result }
```

### 运维接口示例

#### 系统状态检查
```yaml
module: admin
endpoint: system_status
method: GET
path: /admin/status
roles: [admin]

steps:
  - admin.docs: { out: endpoints }
  - admin.plugins_usage: { out: plugins }
  - obs.metrics: { out: metrics }
  
  - response:
      status: 200
      body:
        endpoints_count: "{{ len(endpoints) }}"
        plugins: "{{ plugins }}"
        metrics: "{{ metrics }}"
```

#### 配置检查接口
```yaml
module: admin
endpoint: config_lint
method: GET
path: /admin/config/lint
roles: [admin]

steps:
  - admin.lint: { out: lint_results }
  
  - branch:
      if: "{{ lint_results.errors }}"
      then:
        - response:
            status: 500
            body: 
              status: "error"
              errors: "{{ lint_results.errors }}"
  
  - response:
      status: 200
      body: 
        status: "ok"
        warnings: "{{ lint_results.warnings }}"
```

## 监控与指标

### Prometheus 指标导出
```yaml
steps:
  - obs.metrics: { out: prometheus_metrics }
  
  - response:
      status: 200
      headers:
        Content-Type: "text/plain; version=0.0.4"
      body: "{{ prometheus_metrics }}"
```

### 自定义指标收集
```yaml
module: metrics
endpoint: api_metrics
method: GET
path: /metrics/api
roles: [admin]

steps:
  - obs.metrics: { out: system_metrics }
  
  - plugin.call:
      plugin: metrics_aggregator
      function: get_api_stats
      out: api_stats
  
  - response:
      status: 200
      body:
        system: "{{ system_metrics }}"
        api: "{{ api_stats }}"
```

## 权限管理

### 权限扫描与检查
```yaml
module: admin
endpoint: permissions_report
method: GET
path: /admin/permissions
roles: [admin]

steps:
  - admin.permissions_scan: { out: permissions_report }
  
  - response:
      status: 200
      body: "{{ permissions_report }}"
```

### 权限验证接口
```yaml
module: auth
endpoint: check_permission
method: POST
path: /auth/permission/check

request:
  body:
    user_id: { type: integer, required: true }
    permission: { type: string, required: true }

steps:
  - plugin.call:
      plugin: auth_plugin
      function: check_permission
      params: 
        user_id: "{{ body.user_id }}"
        permission: "{{ body.permission }}"
      out: has_permission
  
  - response:
      status: 200
      body: 
        has_permission: "{{ has_permission }}"
```

## 热重载管理

### 配置热重载
```yaml
module: admin
endpoint: reload_config
method: POST
path: /admin/config/reload
roles: [admin]

steps:
  - admin.reload: { out: reload_result }
  
  - branch:
      if: "{{ reload_result.success }}"
      then:
        - response:
            status: 200
            body: 
              status: "success"
              message: "配置重载成功"
      else:
        - response:
            status: 500
            body: 
              status: "error"
              message: "{{ reload_result.error }}"
```

## 前端集成

### Portal 页面配置
框架提供内置的Portal页面，可通过以下方式访问：

- **接口文档**：`/docs`
- **OpenAPI规范**：`/openapi.json`
- **管理界面**：`/admin` (需要管理员权限)

### 自定义前端集成
```yaml
# 静态资源托管配置
module: portal
endpoint: serve_static
method: GET
path: /portal/{file*}

steps:
  - blob.serve:
      ds: local
      file: "portal/{{ path.file }}"
      mime: "{{ guessMime(path.file) }}"
```

## 最佳实践

### 文档生成实践
1. **定期生成**：在CI/CD流水线中自动生成文档
2. **版本控制**：将生成的文档纳入版本控制
3. **字段完整**：为所有接口配置完整的docs字段
4. **示例丰富**：提供详细的请求响应示例

### 运维管理实践
1. **权限控制**：所有管理接口都需要管理员权限
2. **监控告警**：设置系统指标的监控告警
3. **备份策略**：定期备份配置和重要数据
4. **日志审计**：记录所有管理操作日志

### 性能优化
1. **缓存策略**：对频繁访问的管理数据使用缓存
2. **异步处理**：耗时的管理操作使用异步处理
3. **资源限制**：对管理接口设置适当的限流策略

## 完整示例：运维仪表盘

```yaml
module: admin
endpoint: dashboard
method: GET
path: /admin/dashboard
roles: [admin]

steps:
  - admin.docs: { out: endpoints }
  - admin.plugins_usage: { out: plugins }
  - obs.metrics: { out: metrics }
  - admin.permissions_scan: { out: permissions }
  
  - sql.query:
      ds: main
      sql: "SELECT COUNT(*) as user_count FROM users"
      out: user_stats
  
  - sql.query:
      ds: main
      sql: "SELECT COUNT(*) as api_count FROM api_logs WHERE created_at > DATE_SUB(NOW(), INTERVAL 1 HOUR)"
      out: api_stats
  
  - response:
      status: 200
      body:
        endpoints: "{{ len(endpoints) }}"
        plugins: "{{ plugins }}"
        metrics: "{{ metrics }}"
        permissions: "{{ permissions }}"
        users: "{{ user_stats.user_count }}"
        hourly_requests: "{{ api_stats.api_count }}"
```

## 下一步学习

完成文档与运维管理后，您已经掌握了配置化API框架的所有高级功能。接下来可以进入第四阶段学习生产环境部署和优化：

[第四阶段：生产环境部署](../第四阶段/01-生产环境准备.md)
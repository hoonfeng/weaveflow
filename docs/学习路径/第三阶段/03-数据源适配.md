# 数据源适配与扩展

## 数据源类型概述

配置化API框架支持多种数据源类型，所有配置均在 `configs/project.yaml` 中定义：

- **SQL数据库**：MySQL、PostgreSQL、SQLite等
- **KV存储**：Redis、内存KV等
- **缓存**：内存缓存、Redis缓存
- **Blob存储**：本地文件存储、云存储
- **向量数据库**：Qdrant、内存向量库

## SQL 数据库配置

### 数据库连接配置
```yaml
# configs/project.yaml
datasources:
  sql:
    main:
      driver: mysql
      dsn: "${DB_DSN:root:password@tcp(localhost:3306)/mydb}"
      maxOpenConns: 20
      maxIdleConns: 5
      connMaxLifetime: 300s
    
    log_db:
      driver: sqlite
      dsn: "file:logs.db?cache=shared&mode=rwc"
      maxOpenConns: 1
```

### SQL 查询操作
```yaml
steps:
  - sql.query:
      ds: main
      sql: "SELECT id, name, email FROM users WHERE id = ?"
      params: { id: "{{ toint(path.id) }}" }
      order: [id]
      out: user
```

### SQL 执行操作
```yaml
steps:
  - sql.exec:
      ds: main
      sql: "UPDATE users SET name = ?, email = ? WHERE id = ?"
      params: 
        name: "{{ body.name }}"
        email: "{{ body.email }}"
        id: "{{ toint(path.id) }}"
      order: [name, email, id]
      out: update_result
```

### SQL 事务管理
```yaml
steps:
  - transaction:
      ds: main
      steps:
        - sql.exec:
            sql: "INSERT INTO orders (user_id, amount) VALUES (?, ?)"
            params: { user_id: "{{ body.user_id }}", amount: "{{ body.amount }}" }
            out: order_result
        
        - sql.exec:
            sql: "UPDATE accounts SET balance = balance - ? WHERE user_id = ?"
            params: { amount: "{{ body.amount }}", user_id: "{{ body.user_id }}" }
            out: update_result
```

## KV 存储配置

### Redis KV 配置
```yaml
# configs/project.yaml
datasources:
  kv:
    redis_cache:
      type: redis
      addr: "127.0.0.1:6379"
      db: 0
```

### KV 操作示例
```yaml
steps:
  - kv.set: 
      ds: redis_cache 
      key: "user:{{ path.id }}" 
      value: "{{ user }}"
      ttl: 24h
  
  - kv.get: 
      ds: redis_cache 
      key: "user:{{ path.id }}" 
      out: cached_user
  
```

## 缓存配置

### 内存缓存配置
```yaml
# configs/project.yaml
datasources:
  cache:
    default:
      policy: ttl
      capacity: 10000
      defaultTTL: 5m
```

### 缓存操作示例
```yaml
steps:
  - cache.set: 
      key: "config:v1" 
      value: "{{ config_data }}" 
      ttl: 1h
  
  - cache.get: 
      key: "config:v1" 
      out: cached_config
```

## Blob 存储配置

### 本地Blob存储
```yaml
# configs/project.yaml
datasources:
  blob:
    local:
      type: local
      basePath: storage/
```

## 向量数据库配置

### Qdrant 向量库配置
```yaml
# configs/project.yaml
datasources:
  vector:
    main:
      type: qdrant
      endpoint: "http://localhost:6333"
      apiKey: "${QDRANT_API_KEY:}"
```

### 向量操作示例
```yaml
steps:
  - vector.ensure:
      ds: main
      collection: "products"
      size: 1536
      metric: "Cosine"
  
  - vector.upsert:
      ds: main
      collection: "products"
      id: "{{ body.id }}"
      vec: "{{ body.embedding }}"
      meta: "{{ body.meta }}"
  
  - vector.search:
      ds: main
      collection: "products"
      vec: "{{ body.embedding }}"
      topK: 10
      out: search_results
```

## 多数据源联合查询示例

### 缓存+数据库查询模式
```yaml
steps:
  - cache.get:
      key: "user:{{ path.id }}"
      out: cached_user
  
  - branch:
      if: "{{ cached_user }}"
      then:
        - response:
            status: 200
            body: "{{ cached_user }}"
  
  - sql.query:
      ds: main
      sql: "SELECT * FROM users WHERE id = ?"
      params: { id: "{{ toint(path.id) }}" }
      out: user
  
  - branch:
      if: "{{ not user }}"
      then:
        - response:
            status: 404
            body: { error: "用户不存在" }
  
  - cache.set:
      key: "user:{{ path.id }}"
      value: "{{ user }}"
      ttl: 1h
  
  - response:
      status: 200
      body: "{{ user }}"
```

## SQL 日志与调试

所有SQL操作会自动记录到 `ctx.vars.sql_log`，便于调试与审计：

```yaml
steps:
  - sql.query:
      ds: main
      sql: "SELECT * FROM users WHERE status = ?"
      params: { status: "active" }
      out: users
  
  - response:
      status: 200
      body: 
        users: "{{ users }}"
        sql_log: "{{ ctx.vars.sql_log }}"  # 包含执行的SQL语句和参数
```

## 环境变量配置

使用环境变量进行敏感数据配置：

```yaml
# configs/project.yaml
datasources:
  sql:
    main:
      driver: mysql
      dsn: "${DATABASE_URL:mysql://user:pass@localhost:3306/dbname}"
  
  kv:
    redis_cache:
      type: redis
      addr: "${REDIS_HOST:localhost}:${REDIS_PORT:6379}"
      password: "${REDIS_PASSWORD:}"
```

## 最佳实践

1. **连接池配置**：根据负载合理设置maxOpenConns和maxIdleConns
2. **超时设置**：为所有外部服务设置合理的超时时间
3. **错误处理**：使用branch步骤处理数据源操作失败
4. **缓存策略**：合理使用缓存减少数据库压力
5. **环境隔离**：使用环境变量区分开发、测试、生产环境配置

## 下一步学习

完成数据源适配后，继续学习：[钩子机制与插件集成](../第三阶段/04-钩子与插件.md)
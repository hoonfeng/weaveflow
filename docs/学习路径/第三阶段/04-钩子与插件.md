# 钩子机制与插件集成

## 钩子机制概述

钩子（Hooks）允许在接口执行的特定阶段插入自定义逻辑，包括：

- **Auth钩子**：在鉴权前执行
- **Before钩子**：在执行步骤前执行
- **After钩子**：在执行步骤后执行

## 全局钩子配置

### 配置文件位置
全局钩子配置在 `configs/hooks/` 目录下的YAML文件中。

### 全局钩子示例（按文件拆分）
```yaml
# configs/hooks/auth.yaml
auth:
  - kind: plugin
    name: global_auth_check
    match: { module: admin }
    params:
      plugin: auth
      function: check
      headers: { user: X-User-Id }

# configs/hooks/before.yaml
before:
  - kind: plugin
    name: preflight
    match: { pathPrefix: "/api/" }
    params: { plugin: metrics, function: preflight }

# configs/hooks/after.yaml
after:
  - kind: plugin
    name: audit
    match: { method: [GET, POST], module: admin }
    params: { plugin: metrics, function: audit }
```

### 匹配条件
钩子可通过以下条件匹配（与实现一致）：
- `module/endpoint/method/path/pathPrefix`
- `pathRegex` 正则匹配路径
- `interfaces` 指定完整 "METHOD PATH" 列表
- `label/labelsAny/labelsAll` 基于接口标签匹配

## 接口级钩子配置

### 覆盖全局钩子
```yaml
module: users
endpoint: create_user
method: POST
path: /api/users

hooks:
  disable: [global_auth_check]  # 禁用特定全局钩子
  
  before:
    - kind: plugin
      name: custom_preflight
      params: { plugin: validation, function: pre_create }
  
  after:
    - kind: plugin
      name: post_creation
      params: { plugin: notification, function: user_created }
```

### 完全自定义钩子
```yaml
hooks:
  auth:
    - kind: plugin
      name: custom_auth
      params: { plugin: auth, function: custom_check }
  
  before:
    - kind: plugin
      name: request_logging
      params: { plugin: logging, function: log_request }
  
  after:
    - kind: plugin
      name: response_logging
      params: { plugin: logging, function: log_response }
```

## 插件系统配置

### 插件注册配置
```yaml
# configs/project.yaml
plugins:
  enabled: true
  registry:
    - name: string_reverse
      executable:
        windows: plugins/string_reverse.exe
        unix: ./plugins/string_reverse
      instances: 1
      timeout: 300ms
      queueSize: 1024
      functions: ["reverse"]
      env:
        PLUGIN_MODE: "${PLUGIN_MODE:prod}"
      envFrom: ["*"]  # 将所有系统环境变量传入插件
```

### 多插件配置示例
```yaml
plugins:
  registry:
    - name: auth_plugin
      executable:
        windows: plugins/auth.exe
        unix: ./plugins/auth
      instances: 2
      timeout: 1s
      functions: ["authenticate", "authorize"]
    
    - name: payment_plugin
      executable:
        windows: plugins/payment.exe
        unix: ./plugins/payment
      instances: 1
      timeout: 5s
      functions: ["create_payment", "check_status"]
      env:
        PAYMENT_API_KEY: "${PAYMENT_API_KEY}"
```

## 插件调用示例

### 基本插件调用
```yaml
steps:
  - plugin.call:
      plugin: string_reverse
      function: reverse
      params: { text: "{{ body.text }}" }
      out: reversed_text
  
  - response:
      status: 200
      body: "{{ reversed_text }}"
```

### 带重试机制的插件调用
```yaml
steps:
  - plugin.call:
      plugin: payment_processor
      function: process_payment
      params: 
        amount: "{{ body.amount }}"
        currency: "{{ body.currency }}"
      retry: 3
      backoff: 500
      out: payment_result
```

### 熔断器保护
```yaml
steps:
  - plugin.call:
      plugin: external_api
      function: fetch_data
      params: { query: "{{ body.query }}" }
      circuit: 
        key: "api.data_fetch"
        threshold: 5
        openMs: 30000
        fallback: { error: "服务暂时不可用" }
      out: api_data
```

## 完整示例：认证插件集成

### 认证插件配置
```yaml
# configs/project.yaml
plugins:
  registry:
    - name: jwt_auth
      executable:
        windows: plugins/jwt_auth.exe
        unix: ./plugins/jwt_auth
      instances: 2
      timeout: 500ms
      functions: ["verify", "decode"]
      env:
        JWT_SECRET: "${JWT_SECRET:default_secret}"
```

### 全局认证钩子
```yaml
# configs/hooks/auth.yaml
auth:
  - kind: plugin
    name: jwt_verification
    match: { pathPrefix: "/api/" }
    params: 
      plugin: jwt_auth
      function: verify
      token: "{{ header.Authorization }}"
```

> 说明：钩子不支持 `onError`；认证失败时由钩子直接返回 401，或在接口处理阶段进行错误响应。

### 参数注入与请求散列
- `params.headers: { dstKey: Header-Name }` 将请求头注入插件参数（modules/apphooks/config.go:189–194）
- `bodyHash: sha256` 可注入请求体 SHA256 散列到参数 `body_hash`（modules/apphooks/config.go:205–211）
```

### 接口中使用插件数据
```yaml
module: users
endpoint: get_profile
method: GET
path: /api/users/profile

steps:
  - plugin.call:
      plugin: jwt_auth
      function: decode
      params: { token: "{{ header.Authorization }}" }
      out: token_data
  
  - sql.query:
      ds: main
      sql: "SELECT id, name, email FROM users WHERE id = ?"
      params: { id: "{{ token_data.user_id }}" }
      out: user_profile
  
  - response:
      status: 200
      body: "{{ user_profile }}"
```

## 插件管理操作

### 插件状态监控
```yaml
steps:
  - admin.plugins_usage:
      out: plugins_status
  
  - response:
      status: 200
      body: "{{ plugins_status }}"
```

### 插件热重载
```yaml
steps:
  - admin.reload:
      out: reload_result
  
  - response:
      status: 200
      body: "{{ reload_result }}"
```

## 错误处理与降级

### 插件调用错误处理
```yaml
steps:
  - plugin.call:
      plugin: external_service
      function: get_data
      params: { id: "{{ path.id }}" }
      out: external_data
      onError:
        - response:
            status: 503
            body: { error: "外部服务不可用" }
```

### 降级策略
```yaml
steps:
  - plugin.call:
      plugin: recommendation
      function: get_recommendations
      params: { user_id: "{{ path.user_id }}" }
      fallback: { items: [] }
      out: recommendations
```

## 最佳实践

1. **超时设置**：为所有插件调用设置合理的超时时间
2. **熔断保护**：对关键插件启用熔断器防止雪崩
3. **错误处理**：使用onError和fallback处理插件失败
4. **资源管理**：根据负载合理设置插件实例数
5. **环境隔离**：使用环境变量管理插件配置
6. **监控告警**：通过admin操作监控插件状态

## 下一步学习

完成钩子与插件集成后，继续学习：[文档生成与运维管理](../第三阶段/05-文档与运维.md)
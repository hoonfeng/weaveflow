# 第四阶段：生产环境部署与运维（4-5天）

## 5.5 故障排查与问题解决

### 目标
掌握生产环境中常见问题的诊断和解决方法，建立完善的故障排查体系。

### 5.5.1 常见问题排查

#### 服务启动问题

**服务无法启动**
```bash
# 检查端口占用
netstat -tlnp | grep 8080

# 检查配置文件语法
go run ./cmd/server --check-config

# 查看详细错误信息
./api-server --log-level=debug

# 检查依赖库
ldd ./api-server  # Linux
./api-server --version
```

**配置文件语法错误**
```yaml
# 调试接口配置
module: debug
endpoint: config_check
method: GET
path: /debug/config

steps:
  - admin.lint: { out: lint_results }
  - response:
      status: 200
      body: "{{ lint_results }}"
```

#### 接口访问异常

**接口返回404**
- 检查接口配置文件路径：`configs/interfaces/<module>/<endpoint>.yaml`
- 确认热重载是否启用：`server.autoReload: true`
- 查看服务日志确认接口是否成功加载

**接口返回500错误**
```yaml
# 错误信息收集接口
module: debug
endpoint: error_info
method: GET
path: /debug/error

steps:
  - response:
      status: 200
      body:
        timestamp: "{{ now }}"
        version: "1.0.0"
        status: "healthy"
```

#### 数据库连接问题

**数据库连接失败**
```bash
# 测试数据库连接
mysql -h localhost -u root -p -e "SELECT 1"

# 检查连接池状态
curl -X GET http://localhost:8080/debug/db/stats
```

```yaml
# 数据库连接状态检查接口
module: admin
endpoint: db_stats
method: GET
path: /admin/db/stats
roles: [admin]

steps:
  - sql.query:
      ds: default
      query: "SHOW STATUS LIKE '%onn%'"
      out: db_status
  - response:
      status: 200
      body: "{{ db_status }}"
```

### 5.5.2 认证与授权问题

#### JWT认证失败
- **Q**: JWT token无效或过期
- **A**: 检查token有效期，确认JWT配置中的secret、issuer、audience是否正确

```yaml
# JWT配置验证接口
module: auth
endpoint: jwt_config
method: GET
path: /auth/jwt/config
roles: [admin]

steps:
  - response:
      status: 200
      body:
        secret_length: "{{ len(security.jwt.secret) }}"
        issuer: "{{ security.jwt.issuer }}"
        audience: "{{ security.jwt.audience }}"
        expires_in: "{{ security.jwt.expiresIn }}"
```

#### API Key认证失败
- **Q**: ApiKey签名验证失败
- **A**: 检查以下要素：
  - `X-Timestamp`是否在允许偏差内（默认300秒）
  - `X-Nonce`是否重复使用
  - `bodyHash`计算是否正确
  - HMAC secret配置是否正确

```bash
# API Key签名验证脚本
#!/bin/bash

TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
NONCE=$(uuidgen)
BODY='{"amount":100,"currency":"USD"}'
BODY_HASH=$(echo -n "$BODY" | sha256sum | cut -d' ' -f1)

MESSAGE="POST\n/api/payments\n$TIMESTAMP\n$NONCE\n$BODY_HASH"
SIGNATURE=$(echo -n "$MESSAGE" | openssl dgst -sha256 -hmac "your-hmac-secret" -binary | base64 | tr '+/' '-_' | tr -d '=')

echo "Timestamp: $TIMESTAMP"
echo "Nonce: $NONCE"
echo "Body Hash: $BODY_HASH"
echo "Signature: $SIGNATURE"
```

### 5.5.3 性能问题排查

#### 性能分析接口
```yaml
module: admin
endpoint: performance_profile
method: GET
path: /admin/performance
roles: [admin]

steps:
  - plugin.call:
      plugin: profiler
      function: profile
      params: { duration: "30s" }
      out: profile_data
  - response:
      status: 200
      body: "{{ profile_data }}"
```

#### 慢查询分析
```yaml
module: admin
endpoint: slow_queries
method: GET
path: /admin/db/slow-queries
roles: [admin]

steps:
  - sql.query:
      ds: default
      query: |
        SELECT 
          query, 
          execution_count,
          total_execution_time,
          avg_execution_time,
          max_execution_time
        FROM performance_schema.events_statements_summary_by_digest
        ORDER BY avg_execution_time DESC
        LIMIT 10
      out: slow_queries
  - response:
      status: 200
      body: "{{ slow_queries }}"
```

### 5.5.4 配置相关问题

#### 限流不生效
- **Q**: 设置了限流但无效
- **A**: 确认以下配置：
  - 端点 `rateLimit.rps > 0` 且与 `burst` 值合理
  - 如果启用 `perIp|perTenant|perKey`，确保请求头存在对应键值
  - 检查全局限流配置是否冲突

```yaml
# 限流状态检查接口
module: admin
endpoint: rate_limit_status
method: GET
path: /admin/rate-limit/status
roles: [admin]

steps:
  - response:
      status: 200
      body:
        global_enabled: "{{ rateLimit.enabled }}"
        global_rps: "{{ rateLimit.rps }}"
        global_burst: "{{ rateLimit.burst }}"
        per_ip: "{{ rateLimit.perIp }}"
```

#### 事务未生效
- **Q**: 配置了事务但未生效
- **A**: 确认以下要点：
  - 仅在配置 `transaction: { ds }` 时路由会自动插入事务处理
  - 检查步骤中是否包含 `sql.*` 操作
  - 确认数据源配置正确

```yaml
# 事务测试接口
module: test
endpoint: transaction_test
method: POST
path: /test/transaction

transaction: { ds: default }

steps:
  - sql.exec:
      ds: default
      query: "INSERT INTO test_table (name) VALUES ('test1')"
  - sql.exec:
      ds: default
      query: "INSERT INTO test_table (name) VALUES ('test2')"
  - response:
      status: 200
      body: { success: true }
```

### 5.5.5 文件上传问题

#### 上传解析失败
- **Q**: 文件上传解析失败
- **A**: 检查以下配置：
  - 非 `multipart/form-data` 时，框架将原始体视为单文件 `infile`
  - 确保 `request.file.files` 字段声明正确
  - 检查文件大小和类型约束配置

```yaml
# 上传测试接口
module: test
endpoint: upload_test
method: POST
path: /test/upload

steps:
  - upload.save:
      ds: local
      field: file
      out: upload_result
      constraints:
        maxSize: 10MB
        allowedTypes: ["image/jpeg", "image/png", "application/pdf"]
  - response:
      status: 200
      body: "{{ upload_result }}"
```

### 5.5.6 插件相关问题

#### 插件调用失败
```yaml
# 插件状态检查接口
module: admin
endpoint: plugin_status
method: GET
path: /admin/plugins/status
roles: [admin]

steps:
  - plugin.call:
      plugin: health_check
      function: status
      out: plugin_status
  - response:
      status: 200
      body: "{{ plugin_status }}"
```

#### 插件健康检查
```bash
# 检查插件进程状态
ps aux | grep goproc

# 检查插件日志
tail -f /var/log/goproc.log
```

### 5.5.7 热重载问题

#### 热重载验证
- **Q**: 配置修改后未生效
- **A**: 使用以下方法验证：
  - 修改 `configs/interfaces` 后观察日志中重载摘要（新增/移除/未变）
  - 确认 `server.autoReload: true`
  - 检查文件权限和监控配置

```yaml
# 热重载状态接口
module: admin
endpoint: reload_status
method: GET
path: /admin/reload/status
roles: [admin]

steps:
  - admin.reload_status: { out: reload_status }
  - response:
      status: 200
      body: "{{ reload_status }}"
```

### 5.5.8 调试技巧

#### SQL调试
```yaml
# SQL执行轨迹调试接口
module: debug
endpoint: sql_trace
method: GET
path: /debug/sql/trace

steps:
  - sql.query:
      ds: default
      query: "SELECT * FROM users WHERE id = ?"
      params: [1]
      out: user_data
  # 打印SQL执行轨迹
  - response:
      status: 200
      headers:
        X-SQL-Trace: "{{ ctx.vars.sql_log }}"
      body: "{{ user_data }}"
```

#### 请求追踪
```yaml
# 请求追踪接口
module: debug
endpoint: request_trace
method: GET
path: /debug/request/trace

steps:
  - response:
      status: 200
      headers:
        X-Trace-ID: "{{ uuid }}"
        X-Request-Time: "{{ now }}"
        X-Execution-Time: "{{ ctx.vars.execution_time }}"
      body:
        trace_id: "{{ uuid }}"
        timestamp: "{{ now }}"
        headers: "{{ request.headers }}"
        query: "{{ request.query }}"
```

### 5.5.9 日志分析

#### 日志配置检查
```yaml
# 日志级别检查接口
module: admin
endpoint: log_level
method: GET
path: /admin/log/level
roles: [admin]

steps:
  - response:
      status: 200
      body:
        current_level: "info"
        available_levels: ["debug", "info", "warn", "error"]
        log_file: "/var/log/api-server.log"
```

#### 日志查询接口
```yaml
module: admin
endpoint: log_query
method: GET
path: /admin/logs/query
roles: [admin]

steps:
  - plugin.call:
      plugin: log_analyzer
      function: query
      params: 
        level: "error"
        timeframe: "1h"
        limit: 100
      out: error_logs
  - response:
      status: 200
      body: "{{ error_logs }}"
```

### 5.5.10 系统监控

#### 系统状态接口
```yaml
module: admin
endpoint: system_status
method: GET
path: /admin/system/status
roles: [admin]

steps:
  - plugin.call:
      plugin: system_monitor
      function: status
      out: system_status
  - response:
      status: 200
      body: "{{ system_status }}"
```

#### 资源使用监控
```yaml
module: admin
endpoint: resource_usage
method: GET
path: /admin/resources/usage
roles: [admin]

steps:
  - plugin.call:
      plugin: resource_monitor
      function: usage
      out: resource_usage
  - response:
      status: 200
      body: "{{ resource_usage }}"
```

### 5.5.11 故障排查流程

#### 标准排查流程
1. **确认问题现象**：记录错误信息、发生时间、影响范围
2. **检查日志**：查看应用日志、系统日志、错误日志
3. **验证配置**：使用 `admin.lint` 检查配置语法
4. **测试接口**：使用调试接口验证功能
5. **分析性能**：检查性能指标和资源使用情况
6. **排查依赖**：验证数据库、缓存、插件等依赖服务
7. **实施修复**：根据分析结果进行修复
8. **验证修复**：测试修复效果并监控运行状态

#### 紧急处理措施
- 重启服务：`systemctl restart api-server`
- 回滚配置：恢复之前的配置文件版本
- 禁用功能：临时禁用有问题接口或插件
- 扩容资源：增加服务器资源应对性能问题

### 5.5.12 预防措施

#### 监控告警配置
```yaml
# 监控告警接口
module: admin
endpoint: monitor_alerts
method: GET
path: /admin/monitor/alerts
roles: [admin]

steps:
  - plugin.call:
      plugin: alert_manager
      function: list_alerts
      out: alerts
  - response:
      status: 200
      body: "{{ alerts }}"
```

#### 健康检查接口
```yaml
module: health
endpoint: check
method: GET
path: /health

steps:
  - sql.query:
      ds: default
      query: "SELECT 1"
      out: db_ok
  - plugin.call:
      plugin: cache
      function: ping
      out: cache_ok
  - response:
      status: 200
      body:
        status: "healthy"
        database: "{{ db_ok.0.'1' == 1 }}"
        cache: "{{ cache_ok.success }}"
        timestamp: "{{ now }}"
```

## 总结

通过本节的故障排查指南，您应该能够：

1. **快速诊断问题**：使用各种调试接口和工具快速定位问题根源
2. **解决常见故障**：掌握认证、数据库、性能等常见问题的解决方法
3. **建立监控体系**：配置完善的监控和告警系统预防问题发生
4. **实施应急措施**：在紧急情况下采取正确的处理措施
5. **持续优化改进**：基于故障经验不断优化系统稳定性和可靠性

故障排查是运维工作的重要组成部分，建立完善的排查流程和工具能够显著提高系统可用性和运维效率。
# 生产环境配置

## 环境变量管理

### .env 文件配置

在生产环境中，使用环境变量管理敏感配置：

```bash
# .env 文件示例
# 数据库配置
DB_DSN="user:password@tcp(production-db:3306)/app_db?parseTime=true"

# 安全配置
JWT_SECRET="your-production-jwt-secret-key-here"
REDIS_PASSWORD="production-redis-password"

# 服务配置
PORT="8080"
ENV="production"

# 插件配置
PLUGIN_MODE="prod"
API_URL="https://api.yourdomain.com"

# 外部服务
QDRANT_API_KEY="your-qdrant-api-key"
PAYMENT_API_KEY="your-payment-api-key"
```

### 多环境配置策略

```yaml
# configs/project.yaml
server:
  port: ${PORT:8080}
  env: ${ENV:development}
  autoReload: ${AUTO_RELOAD:false}

security:
  jwtSecret: ${JWT_SECRET:dev-secret}
  apiKey:
    hmacSecret: ${HMAC_SECRET:dev-hmac-secret}

datasources:
  sql:
    main:
      driver: mysql
      dsn: ${DB_DSN:root:password@tcp(localhost:3306)/dev_db}
      maxOpenConns: ${DB_MAX_CONNS:20}
      maxIdleConns: ${DB_IDLE_CONNS:5}
  
  kv:
    redis_cache:
      type: redis
      addr: "${REDIS_HOST:localhost}:${REDIS_PORT:6379}"
      password: ${REDIS_PASSWORD:}
      db: ${REDIS_DB:0}

plugins:
  enabled: ${PLUGINS_ENABLED:true}
  registry:
    - name: auth_plugin
      executable:
        windows: ${PLUGIN_DIR:plugins}/auth.exe
        unix: ${PLUGIN_DIR:plugins}/auth
      instances: ${AUTH_PLUGIN_INSTANCES:2}
      timeout: ${AUTH_PLUGIN_TIMEOUT:1000}
```

## 安全配置

### JWT 安全配置（项目级扁平字段）
```yaml
security:
  authType: jwt
  jwtSecret: ${JWT_SECRET}
  jwtIssuer: ${JWT_ISSUER:your-app}
  jwtAudience: ${JWT_AUDIENCE:your-app-users}
  stripeWebhookSecret: ${STRIPE_WH_SECRET:}
```

### API Key + HMAC 说明
HMAC 验签不依赖项目级 `security` 字段，服务端从数据库表 `api_keys` 读取密钥并完成以下校验：
- 时间戳 `X-Timestamp` 为 RFC3339 且在容差范围内
- 随机数 `X-Nonce` 在 TTLCache 中未重复
- 签名 `X-Signature` 按 `METHOD\nPATH\nTS\nNONCE\nBODY_HASH` 验证（参考 internal/router/auth_hmac.go）

### 认证授权详细配置

#### JWT 认证配置
```yaml
# configs/project.yaml（扁平结构）
security:
  authType: jwt
  jwtSecret: ${JWT_SECRET:your-super-secret-key}
  jwtIssuer: ${JWT_ISSUER:your-app}
  jwtAudience: ${JWT_AUDIENCE:your-app-users}

# 接口配置中的权限控制
module: users
endpoint: admin_list
method: GET
path: /api/admin/users
auth: jwt
roles: ["admin"]
permissions: ["users.read", "users.manage"]
```

#### API Key + HMAC 接口配置
```yaml
# 接口配置
module: payments
endpoint: create_payment
method: POST
path: /api/payments
auth: apikey
```

### 防重放攻击配置
```yaml
# 接口级防重放配置
module: sensitive
endpoint: transfer_funds
method: POST
path: /api/transfer
rateLimit:
  rps: 5
  burst: 10
  perIp: true
security:
  replayProtection:
    enabled: true
    nonceTTL: 300
    maxNonceAge: 300
```

### 限流配置
```yaml
# 全局限流
rateLimit:
  global:
    enabled: true
    rps: ${GLOBAL_RPS:100}
    burst: ${GLOBAL_BURST:50}

# 端点级限流示例
module: api
endpoint: high_traffic
method: GET
path: /api/high-traffic
rateLimit:
  rps: 10
  burst: 5
  perIp: true

# 租户级限流示例
module: multi_tenant
endpoint: tenant_data
method: GET
path: /api/tenant/{tenantId}/data
rateLimit:
  rps: 50
  burst: 20
  perTenant: true  # 从 X-Tenant-Id 头获取租户标识

# API Key 级限流示例
module: external_api
endpoint: external_data
method: GET
path: /api/external/data
rateLimit:
  rps: 100
  burst: 30
  perKey: true     # 从 X-Api-Key 头获取API密钥标识
```

### 认证授权请求示例

#### JWT 认证请求示例
```bash
# 获取 JWT Token
curl -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"password"}'

# 使用 JWT Token 访问受保护接口
curl -X GET http://localhost:8080/api/admin/users \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
```

#### API Key + HMAC 认证请求示例
```bash
# 生成 HMAC 签名请求
TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
NONCE=$(uuidgen)
BODY='{"amount":100,"currency":"USD"}'
BODY_HASH=$(echo -n "$BODY" | sha256sum | cut -d' ' -f1)

# 构建签名消息
MESSAGE="POST\n/api/payments\n$TIMESTAMP\n$NONCE\n$BODY_HASH"
SIGNATURE=$(echo -n "$MESSAGE" | openssl dgst -sha256 -hmac "your-hmac-secret" -binary | base64 | tr '+/' '-_' | tr -d '=')

# 发送请求
curl -X POST http://localhost:8080/api/payments \
  -H "Content-Type: application/json" \
  -H "X-Api-Key: your-api-key" \
  -H "X-Timestamp: $TIMESTAMP" \
  -H "X-Nonce: $NONCE" \
  -H "X-Signature: $SIGNATURE" \
  -d "$BODY"
```

### 防重放攻击验证

框架会自动验证以下内容：
- `X-Timestamp` 时间戳在允许的容差范围内（默认300秒）
- `X-Nonce` 随机数在缓存中不存在（防止重放攻击）
- `X-Signature` 签名与计算得到的签名匹配

```

## 性能优化配置

### 数据库连接池优化
```yaml
datasources:
  sql:
    main:
      driver: mysql
      dsn: ${DB_DSN}
      maxOpenConns: 100           # 根据数据库配置调整
      maxIdleConns: 20
      connMaxLifetime: 300s
      connMaxIdleTime: 60s
```

### 缓存配置优化
```yaml
datasources:
  cache:
    default:
      policy: ttl
      capacity: 100000            # 增大缓存容量
      defaultTTL: 30m
      cleanupInterval: 5m
```

### 插件性能配置
```yaml
plugins:
  registry:
    - name: heavy_plugin
      executable:
        windows: plugins/heavy.exe
        unix: ./plugins/heavy
      instances: 4                # 增加实例数处理并发
      timeout: 5000               # 适当超时时间
      queueSize: 2048             # 增大队列大小
```

## 监控与日志配置

### Prometheus 监控
```yaml
observability:
  metrics:
    enabled: true
    path: /metrics
    namespace: app
    subsystem: api
  
  tracing:
    enabled: ${TRACING_ENABLED:false}
    exporter: ${TRACING_EXPORTER:jaeger}
    endpoint: ${TRACING_ENDPOINT:localhost:6831}
```

### 日志配置
```yaml
logging:
  level: ${LOG_LEVEL:info}
  format: ${LOG_FORMAT:json}
  
  # 文件输出
  file:
    enabled: ${LOG_FILE_ENABLED:true}
    path: ${LOG_FILE_PATH:logs/app.log}
    maxSize: ${LOG_FILE_MAX_SIZE:100}
    maxBackups: ${LOG_FILE_MAX_BACKUPS:7}
    maxAge: ${LOG_FILE_MAX_AGE:30}
  
  # 标准输出
  stdout:
    enabled: ${LOG_STDOUT_ENABLED:true}
```

## 高可用配置

### 多实例部署配置
```yaml
server:
  port: ${PORT:8080}
  
  # 集群配置
  cluster:
    enabled: ${CLUSTER_ENABLED:false}
    nodes: ${CLUSTER_NODES:}
    
  # 健康检查
  healthCheck:
    enabled: true
    path: /health
    interval: 30s
```

### 会话配置
```yaml
session:
  store: ${SESSION_STORE:redis}
  
  redis:
    addr: "${REDIS_HOST:localhost}:${REDIS_PORT:6379}"
    password: ${REDIS_PASSWORD:}
    db: ${SESSION_REDIS_DB:1}
    
  cookie:
    name: ${SESSION_COOKIE_NAME:session}
    maxAge: ${SESSION_MAX_AGE:86400}
    secure: ${SESSION_COOKIE_SECURE:true}
    httpOnly: ${SESSION_COOKIE_HTTPONLY:true}
```

## 静态资源配置

### 生产环境静态资源
```yaml
static:
  enabled: true
  items:
    - route: /portal/
      dir: ${PORTAL_DIR:webui/portal/dist}
      index: index.html
      spa: true
      strip: true
    
    - route: /admin/
      dir: ${ADMIN_DIR:webui/admin/dist}
      index: index.html
      spa: true
      strip: true
    
    - route: /docs/
      dir: ${DOCS_DIR:docs/generated}
      index: index.html
      spa: false
      strip: true
    
    - route: /robots.txt
      file: ${ROBOTS_FILE:web/robots.txt}
```

## 环境检查配置

### 启动时环境检查
```yaml
bootstrap:
  checks:
    - name: database
      type: sql
      dsn: ${DB_DSN}
      timeout: 30s
    
    - name: redis
      type: redis
      addr: "${REDIS_HOST:localhost}:${REDIS_PORT:6379}"
      password: ${REDIS_PASSWORD:}
      timeout: 10s
    
    - name: plugins
      type: plugins
      timeout: 60s
```

## 配置验证

### 配置校验脚本
创建配置校验脚本确保生产配置正确：

```bash
#!/bin/bash
# config-validate.sh

# 检查必要环境变量
required_vars=("DB_DSN" "JWT_SECRET" "REDIS_PASSWORD")
for var in "${required_vars[@]}"; do
  if [ -z "${!var}" ]; then
    echo "错误: 环境变量 $var 未设置"
    exit 1
  fi
done

# 检查配置文件语法
echo "检查配置文件语法..."
go run ./cmd/configcheck --config configs/project.yaml

# 检查接口配置
echo "检查接口配置..."
go run ./cmd/lint --dir configs/interfaces

echo "配置验证通过!"
```

## 最佳实践

### 安全最佳实践

#### 认证授权安全
1. **密钥管理**：使用环境变量或密钥管理服务，不要硬编码密钥
   - JWT Secret 至少32位随机字符串
   - HMAC Secret 至少64位随机字符串
   - 定期轮换生产环境密钥

2. **JWT 安全配置**
   - 设置合理的 token 过期时间（生产环境建议2-24小时）
   - 启用 token 刷新机制
   - 使用强加密算法（HS256/RS256）
   - 配置正确的 issuer 和 audience

3. **API Key + HMAC 安全**
   - 为每个客户端分配唯一的 API Key
   - HMAC Secret 需要足够长度和复杂度
   - 设置合理的时间戳容差（建议60-300秒）
   - 启用 Nonce 缓存防止重放攻击

4. **权限控制**
   - 遵循最小权限原则，只授予必要权限
   - 使用角色和权限双重控制机制
   - 定期审计接口权限配置

#### 限流与防重放
5. **限流策略**
   - 根据业务需求设置合理的 RPS 限制
   - 针对不同维度进行限流（IP、租户、API Key）
   - 监控限流触发情况，及时调整限制

6. **防重放攻击**
   - 对所有敏感操作启用防重放保护
   - 设置合理的 Nonce TTL（建议300-600秒）
   - 监控重放攻击尝试

#### 通用安全
7. **HTTPS强制**：生产环境强制使用HTTPS
8. **CORS配置**：严格限制跨域请求源
9. **输入验证**：对所有输入数据进行严格验证
10. **日志审计**：记录所有安全相关操作和异常

### 性能最佳实践
1. **连接池优化**：根据负载调整数据库连接池大小
2. **缓存策略**：合理使用缓存减少数据库压力
3. **异步处理**：耗时的操作使用异步处理
4. **监控告警**：设置性能指标监控和告警

### 运维最佳实践
1. **配置版本控制**：所有配置文件纳入版本控制
2. **变更记录**：记录配置变更历史和原因
3. **备份策略**：定期备份配置和重要数据
4. **灾难恢复**：制定灾难恢复计划和演练

## 下一步学习

完成生产环境配置后，继续学习：[性能优化与测试](../第四阶段/03-性能优化.md)
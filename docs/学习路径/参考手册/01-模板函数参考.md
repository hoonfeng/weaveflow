# 模板函数参考（与引擎实现一致）

## 基础
- `len(x)` / `count(x)`：长度；支持字符串/数组/对象
- `tostring(x)` / `tobool(x)` / `toint(x)` / `tofloat(x)`：类型转换
- `upper(x)` / `lower(x)`：大小写转换
- `json_encode(x)`：JSON 字符串
- `sha256(x)` / `sha256_concat(a,b)`：SHA256 十六进制
- `uuid()`：生成随机16字节十六进制字符串

## 逻辑与条件
- `eq(a,b)` / `ne(a,b)`：等于/不等于（字符串比较）
- `gt/ge/lt/le(a,b)`：大小比较（数值）
- `and(a,b)`：逻辑与（truthy 判定）
- `or(a,b)`：逻辑或（返回第一个 truthy 值，否则返回第二个）
- `if(cond, then, else)`：条件表达式
- `coalesce(a,b,...)`：返回第一个 truthy 值
- `not(x)`：逻辑非

## 数学与聚合
- `add/sub/mul/div/mod(a,b)`：加减乘除取余
- `sum(arr)` / `avg(arr)` / `min(arr)` / `max(arr)`：数组聚合（支持 `[]any` / `[]float64`）

## 字符串与数组
- `join(arr, sep)`：连接字符串数组
- `split(str, sep)`：拆分字符串
- `format(fmt, ...args)`：格式化，等同 `sprintf`
- `concat(a, b, ...)`：拼接字符串

## 时间
- `now(mode)`：当前时间；`mode` 支持：
  - `"unix"` → 秒时间戳（float）
  - `"ms"` → 毫秒时间戳（float）
  - 其他/省略 → RFC3339 字符串
- `format_time(ts, layout)`：将时间戳/字符串格式化为 `layout`
- `parse_time(str, layout)`：解析时间字符串为 Unix 时间戳
- `add_duration(base, dur)`：在时间上加持续时间（如 `"15m"`、`"2h"`）

## 示例
```yaml
steps:
  - transform:
      mapping:
        u_upper: "{{ upper(body.username) }}"
        ok: "{{ and(gt(toint(query.page),1), not(eq(body.status,'disabled'))) }}"
        when: "{{ format_time(now, '2006-01-02 15:04:05') }}"
        sum10: "{{ sum([1,2,3,4]) }}"
        id: "{{ uuid }}"
```

> 实现参考：internal/core/engine.go:780–1009
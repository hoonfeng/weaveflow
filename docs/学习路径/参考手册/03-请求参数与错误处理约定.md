# 请求参数与错误处理约定

## 请求参数采集
- 路径参数：直接以路径占位名写入，如 `req["id"]`
- 查询参数：以键名写入，如 `req["page"]`
- 请求头：写入为 `header.<Name>`，如 `req["header.Authorization"]`
- JSON 请求体：解析为对象，顶层键写入 `req`，整体对象写入 `req["body"]`
- 文件上传：
  - `multipart/form-data`：解析表单字段与文件，文件列表写入 `req["file.files"]`，同时写入 `req["file"] = { files }`
  - 兼容原始体上传：当未解析到文件且有请求体时，回退为单文件 `infile`
  - 非 JSON 且有请求体也将回退为文件
- 上传大小限制：默认 `32MB`，可通过 `server.maxUploadSize` 配置（支持 B/KB/MB）

## 取值与校验
- 在步骤中通过 `target` 路径读取：`query.<k>/path.<k>/body.<k>/header.<Name>/file.files` 等
- 文件校验：`maxSize` 限制大小；`types` 支持 MIME 与扩展名双重判断

## 错误处理
- 接口级错误映射：
  - 在接口配置 `errors.default` 中声明 `{ status, body }`，步骤出错时按该映射返回
- 未生成响应：
  - 若执行结束未产生 `response` 步骤，框架返回 `200` 且 `{code:0,msg:"ok"}`，并附带 `sql` 日志（如有）

## 示例
```yaml
module: demo
endpoint: sample
method: POST
path: /api/sample

request:
  body:
    name: { type: string }

steps:
  - validate: { target: body.name, required: true, minLen: 2 }
  - transform:
      mapping:
        auth: "{{ header.Authorization }}"
        uploaded: "{{ len(file.files) }}"
  - response:
      status: 200
      wrap: { code: 0, msg: ok, data: "{{ ctx.vars }}" }

errors:
  default:
    status: 400
    body: { code: 1001, message: "参数错误" }
```

> 参考：参数采集与上传解析 internal/router/router.go:170–240；错误处理与默认响应 internal/router/router.go:493–515